<!-- app/views/layouts/_navbar.html.erb -->

<nav class="O_Navbar">
  <div class="W_NavbarPageLinks">
    <%= link_to "События",    events_path,      class: "A_NavbarPageLink" %>
    <%= link_to "Встречи",    meets_path,       class: "A_NavbarPageLink" %>
    <%= link_to "Сообщества", communities_path, class: "A_NavbarPageLink" %>
  </div>

  <%= link_to "", root_path, class: "A_NavbarLogoLink" %>

  <div class="W_NavbarButtons">
    <!-- Поиск -->
    <button class="A_Button NavbarButton SearchButton" id="SearchButton">
      <div class="Q_Icon MIcon IconSearch"></div>
    </button>

    <!-- ► Блок «Добавить» с выпадающим меню -->
    <div
      class="A_Button NavbarButton AddButton"
      id="AddButton"
      data-controller="add-dropdown"
      data-action="click->add-dropdown#toggle"
    >
      <div class="Q_Icon MIcon IconAdd"></div>

      <!-- Само выпадающее меню -->
      <div
        class="AddDropdownMenu"
        data-add-dropdown-target="menu"
        hidden
      >
        <ul class="AddDropdownList">
          <li class="AddDropdownItem">
            <%= link_to new_event_path, class: "AddDropdownLink" do %>
              <div class="Q_Icon MIcon IconEvent"></div>
              Новое событие
            <% end %>
          </li>
          <li class="AddDropdownItem">
            <%= link_to new_meet_path, class: "AddDropdownLink" do %>
              <div class="Q_Icon MIcon IconMeet"></div>
              Новая встреча
            <% end %>
          </li>
        </ul>
      </div>
    </div>
    <!-- /AddButton -->

    <!-- Профиль -->
    <% if user_signed_in? %>
      <div class="A_NavbarProfileWrapper" data-controller="profile-dropdown">
        <button
          type="button"
          data-profile-dropdown-target="button"
          class="A_NavbarProfileButton"
          id="ProfileButton"
        >
          <% if current_user.profile&.avatar? %>
            <%= image_tag(
                  current_user.profile.avatar.url,
                  alt: current_user.profile.name,
                  class: "A_NavbarAvatar"
                ) %>
          <% else %>
            <div class="A_NavbarAvatar">
              <div class="Q_Icon MIcon IconProfile"></div>
            </div>
          <% end %>
        </button>

        <ul
          class="M_ProfileDropdownMenu"
          data-profile-dropdown-target="menu"
          hidden
        >
          <li class="M_ProfileMenuItem">
            <%= link_to "Мой профиль",
                        profile_path(current_user.profile),
                        class: "A_ProfileMenuLink" %>
          </li>
          <!-- ► «Настройки» -->
          <li class="M_ProfileMenuItem">
            <%= link_to "Настройки",
                        settings_path,
                        class: "A_ProfileMenuLink" %>
          </li>

          <li class="M_ProfileMenuItem">
            <%= button_to "Выйти",
                          destroy_user_session_path,
                          method: :delete,
                          form: { "data-turbo-confirm" => "Вы уверены?" },
                          class: "A_ProfileMenuLink" %>
          </li>
        </ul>
      </div>
    <% else %>
      <div class="A_NavbarProfileWrapper">
        <%= link_to "Войти",
                    new_user_session_path,
                    class: "A_NavbarAuthLink" %>
        <%= link_to "Зарегистрироваться",
                    new_user_registration_path,
                    class: "A_NavbarAuthLink" %>
      </div>
    <% end %>

    <!-- Контейнер для уведомлений -->
    <% if user_signed_in? %>
      <div
        class="NotificationsWrapper"
        data-controller="notifications"
      >
        <!-- Кнопка-«колокольчик» -->
        <div
          id="NotificationsButton"
          class="NavbarButton NotificationsButton <%= 'has-unread' if current_user.unread_notifications.any? %>"
          data-notifications-target="button"
          data-action="click->notifications#toggle"
        >
          <div class="Q_Icon IconNotifications"></div>
          <% if current_user.unread_notifications.any? %>
            <span class="NotificationDot"></span>
          <% end %>
        </div>

        <!-- Панель уведомлений (скрыта атрибутом hidden) -->
        <div
          id="notificationsPanel"
          class="NotificationsPanel"
          data-notifications-target="panel"
          hidden
        >
          <div class="notificationsCounter">
            Уведомления
            <span data-notifications-target="counter">
              <%= current_user.unread_notifications.count %>
            </span>
          </div>

          <div
            data-notifications-target="list"
            class="notificationsList"
          >
            <% current_user.unread_notifications.each do |notification| %>
              <% comment = Comment.find_by(id: notification.comment_id) %>
              <% next unless comment %>
              <% parent = comment.commentable %>
              <% url = polymorphic_url(parent, anchor: "comment_#{comment.id}") %>
              <div class="notification">
                <%= link_to notification.body, url %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
    <!-- /NotificationsWrapper -->
  </div>
</nav>

<%= render "search_form" %>
